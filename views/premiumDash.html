<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expenses</title>
</head>
<style>
    body {
        background-color: bisque;
    }
    .formContainer {
        border: 2px solid;
        background-color: aliceblue;
        padding-left: 6%;
        padding-top: 57px;
        padding-bottom: 41px;
        margin-left: 27%;
        margin-right: 49%;
        margin-top: 6%;
    }
    .detailContainer {
        border: 2px solid;
        background-color: aliceblue;
        padding-left: 6%;
        padding-top: 38px;
        padding-bottom: 173px;
        margin-left: 27%;
        margin-right: 49%;
        margin-top: 0%;
    }
    ul#addExpensesDetails {
        margin-left: -68px;
    }
</style>
<body>
    <div class="formContainer">
        <form action="/expense" method="POST">
            <h2>Expense app</h2>
            <label for="chooseExpense">Enter Expense Amount</label><br>
            <input type="number" id="expenseAmount" name="expenseAmount"><br>
            <label for="chooseDescription">Choose Description</label><br>
            <input type="text" id="chooseDescription" name="Description"><br>
            <label for="category">Choose Category</label><br>
            <select name="chooseCategory" id="category">
                <option id="food">food</option>
                <option id="fuel">fuel</option>
                <option id="electricity">electricity</option>
                <option id="movie">movie</option>
            </select><br>
            <div id="premiumButtn">
                <button type="submit" id="buttn">Add Expenses</button>
            </div>
            <div class="premiumUser">
                <h3>you are a premium user</h3>
                <button type="submit" id="showLeaderBoard">ShowLeaderBoard</button>
            </div>
            
        </form>
    </div>
    <div class="detailContainer">
        <h2 id="form2">Expenses Details</h2>
        <ul id="addExpensesDetails"></ul>
    </div>
    <div id="leaderboard"></div>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
    <script>
        const ShowLeaderBoard=document.getElementById('showLeaderBoard');
        const leaderboardContainer=document.getElementById('leaderboard');
        ShowLeaderBoard.addEventListener('click',getAllData);
        async function getAllData(e) {
                e.preventDefault();
                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch('http://localhost:5500/AllData', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`Error fetching data: ${response.statusText}`);
                    }

                    const data = await response.json();
                    console.log(data);
                    leaderboardContainer.innerHTML = '';

                    data.forEach((user, index) => {
                        const userDiv = document.createElement('div');
                        userDiv.className = 'user-entry';
                        userDiv.innerHTML = `
                            <span class="user-name">Name - ${user.userName}  </span>
                            <span class="total-expenses">Total Expenses - ${user.totalExpenses}</span>
                        `;
                        leaderboardContainer.appendChild(userDiv);
                    });
                } catch (error) {
                    console.error(error);
                }
        }

        const buttn=document.getElementById('buttn');
        buttn.addEventListener('click',postData);
        async function postData(e){
            e.preventDefault();
                const expenseAmount=document.getElementById('expenseAmount').value;
                const Description=document.getElementById('chooseDescription').value;
                const category=document.getElementById('category').value;
                const data={
                    "expense_amount":expenseAmount,
                    "description":Description,
                    "category":category,
                }
            try{
                const token=localStorage.getItem('token');
                const response = await axios.post('http://localhost:5500/expense', data, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const addExpensesDetails=document.getElementById('addExpensesDetails');
                const list=document.createElement('li');
                const btn=document.createElement('button');
                btn.addEventListener('click',async()=>{
                    list.remove();
                    await deleteData(response.data.expenseData.response.id);
                })
                btn.textContent='Delete expense';
                list.innerHTML=expenseAmount+" - "+Description+" - "+category+" - ";
                list.appendChild(btn);
                addExpensesDetails.appendChild(list);
            }catch (error){
                console.log(error);
            }
                
        }
        document.addEventListener('DOMContentLoaded',fetchData);
        async function fetchData(e){
            e.preventDefault();
            try{
                const token=localStorage.getItem('token');
                const response = await axios.get('http://localhost:5500/get_expense', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const getExpense = response.data.getExpense;

                const addExpensesDetails = document.getElementById('addExpensesDetails');
                addExpensesDetails.innerHTML = '';

                getExpense.forEach(expense => {
                    const list = document.createElement('li');
                    const btn = document.createElement('button');
                    btn.textContent = 'Delete expense';

                    btn.addEventListener('click', async () => {
                        list.remove();
                        await deleteData(expense.id);
                    });

                    list.innerHTML = `
                        ${expense.expense_amount} - 
                        ${expense.description} - 
                        ${expense.category} - `;

                    list.appendChild(btn);
                    addExpensesDetails.appendChild(list);
                });

            }catch(error){
                console.log(error);
            }
        }
        async function deleteData(id){
            try{
                const response=await axios.delete(`http://localhost:5500/delete_expense/${id}`);
            }
            catch(error){
                console.log(error);
            }
        }
    </script>
</body>
</html>